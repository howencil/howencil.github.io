---
title: "数据库的四大特性"
date: 2022-06-07T15:31:24+08:00
draft: false
author: 插画师
tags: ["MySQL"]
categories: ["Tech"]
---

## 1.4大特性
1. 原子性：*事务的所有SQL操作作为原子工作单位执行，要么全部执行，要么全部不执行；*
2. 一致性：*事务完成后，所有数据的状态都是一致的，比如说转账，A账户减去了100，B账户则必定加上了100；*
3. 隔离性：*如果有多个事务执行，每个事务做出的修改必须与其他事务隔离；*
4. 持久性：*事务完成后，对数据库数据的修改被持久化存储。*

## 2.4种隔离级别
1. 读未提交：脏读、不可重复读、幻读
2. 读已提交：不可重复读、幻读
3. 可重复读：幻读
4. 可串行化：无
##### 1.脏读：读取未提交的数据
##### 2.不可重复读：前后多次读取，数据内容不一致
##### 3.幻读：前后多次读取，数据总量不一致
**不可重复读和幻读有何区别？**
1. **不可重复读是读取了其他事务更改的数据，针对`update`操作；解决方案：使用行级锁，锁定该行，事务A多次读取操作完成后才释放该锁，这个时候才允许其他事务更改刚才的数据。
   PS:只有通过索引条件检索数据，InnoDB 才使用行级锁，否则，InnoDB 将使用表锁。**
2. **幻读是读取了其他事务新增的数据，针对`insert`和`delete`操作；解决方案：使用表级锁，锁定整张表，事务A多次读取数据总量后才释放锁，这个时候才允许其他事务新增数据。**


## 3.原子性的实现
**MySQL数据库事务的原子性是通过`undo log`来实现的。**
事务所有的修改操作（增删改）的*相反*操作都会写入`undo log`。比如事务执行了一条`insert`语句，那么`undo log`就会记录一条相应的`delete`语句。所以`undo log`是一个逻辑文件，记录的是相应的SQL语句。一旦故障，导致事务无法成功提交，系统则会执行`undo log`中相应的撤销操作，达到事务回滚的目的。
`undo log`也可以实现MVCC（多个并发版本控制）。
## 4.持久性的实现
**MySQL数据库事务的持久性是通过`redo log`实现的。**
事务的所有修改操作（增删改），数据库都会生产一条`redo`日志记录到`redo log`。区别于`undo log`记录SQL语句，`redo log`记录的是事务对数据的哪个数据页做了什么修改，属于物理日志。
`redo`日志应用场景：数据系统直接崩溃，需要进行恢复，一般数据库都会使用按时间点备份的策略。首先将数据库恢复到最近备份的时间点状态，之后读取该时间点之后的`redo log`记录，重新执行相应操作，达到最终恢复的目的。

## 5.日志文件的刷新策略
`undo log` 和`redo log`并不是直接写入磁盘，而是先写入`log buffer`，再等待何时的时机同步到`OS buffer`，再由操作系统决定刷新到磁盘的时间。

![](/数据库的四大特性/1.png)

MySQL主要由3种日志刷新策略，默认是第1种。3种策略，安全性依次下降，效率依次上升。

1. 每次事务提交写入`OS buffer`，并调用`fsync`刷新到磁盘；
2. 每秒写入`OS buffer`,并调用`fsync`刷新到磁盘；
3. 每秒提交写入`OS buffer`，然后每秒调用`fsync`刷新到磁盘。
## 6.隔离性的实现
##### 1.读已提交（允许可重复读、幻读）
实现策略：**数据的读取不加锁，数据的写入、修改、删除需要加行级锁，可以克服脏读，但无法避免不可重复读。**
##### 2.可重复读（允许幻读）
实现策略：**MVCC（多个版本控制）策略**
**行级锁是一个悲观锁，而MVCC是一个乐观锁，乐观锁在一定程度上可以避免加锁操作，因此开销更低。**
**MVCC的具体实现：通过在每行记录后面保存2个隐藏的列来实现，1个保存了行的创建时间，1个保存了行的过期时间（删除时间），这里的时间并不是时间戳，而是系统版本号，每开始一个新事物，系统版本号就会递增。**
- `select`操作：
	- 只查找版本早于（包含等于）当前事务版本的数据行。可以确保数据读取的行，要么是事务开始前就已存在，或事务自身插入或修改的记录。
	- 行的删除版本要么未定义，要么大于当前事务版本号。可以确保事务读取的行，在事务开始前未删除。
- `insert`操作：将新插入的行保存当前版本号为行的版本号。
- `delete`操作：将删除的行保存当前版本号为删除标识。
- `update`操作：变为`insert`和`delete`操作的组合，`insert`的行保存当前版本号为行的版本号，`delete`则保存当前版本号到原来的行做为删除标识。

**通过MVCC策略，可以确保一个事务里面读取的是同一个数据库版本快照。**

> [MySQL事务四大特性实现：面试官的终究拷问_zycxnanwang的博客-CSDN博客_mysql事务四大特性的实现](https://blog.csdn.net/zycxnanwang/article/details/105742160)
